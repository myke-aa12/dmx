<!-- ...existing HTML code... -->
  <script>
    // Eliminar trámite
    document.addEventListener('click', function(e) {
      if (e.target.closest('.btn-eliminar-tramite')) {
        const btn = e.target.closest('.btn-eliminar-tramite');
        const id = btn.getAttribute('data-id');
        Swal.fire({
          title: '¿Eliminar trámite?',
          text: 'Esta acción no se puede deshacer.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#611232',
          cancelButtonColor: '#aaa',
          confirmButtonText: 'Eliminar',
          cancelButtonText: 'Cancelar'
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              const resp = await fetch(`/tramites/${id}/eliminar`, { method: 'POST' });
              const data = await resp.json();
              if (data.success) {
                Swal.fire({ icon: 'success', title: 'Eliminado', text: 'Trámite eliminado correctamente.' });
                location.reload();
              } else {
                Swal.fire({ icon: 'error', title: 'Error', text: data.message });
              }
            } catch {
              Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo eliminar.' });
            }
          }
        });
      }
    });

    // Eliminar proveedor
    document.addEventListener('click', function(e) {
      if (e.target.closest('.btn-eliminar-proveedor')) {
        const btn = e.target.closest('.btn-eliminar-proveedor');
        const id = btn.getAttribute('data-id');
        Swal.fire({
          title: '¿Eliminar proveedor?',
          text: 'Esta acción no se puede deshacer.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#611232',
          cancelButtonColor: '#aaa',
          confirmButtonText: 'Eliminar',
          cancelButtonText: 'Cancelar'
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              const resp = await fetch(`/proveedores/${id}/eliminar`, { method: 'POST' });
              const data = await resp.json();
              if (data.success) {
                Swal.fire({ icon: 'success', title: 'Eliminado', text: 'Proveedor eliminado correctamente.' });
                cargarProveedores();
              } else {
                Swal.fire({ icon: 'error', title: 'Error', text: data.message });
              }
            } catch {
              Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo eliminar.' });
            }
          }
        });
      }
    });
  </script>
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel de administración</title>
  <style>
    body { font-family: Segoe UI, Tahoma, sans-serif; background: #f5f6f8; margin: 0; padding: 30px; }
    .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
    h1 { margin: 0 0 18px; color: #222; }

    .form-inline { display: grid; grid-template-columns: 1.4fr 0.6fr 1fr auto; gap: 10px; align-items: center; margin: 12px 0 22px; }
    .form-inline input { padding: 10px 12px; border: 1px solid #d3d7df; border-radius: 8px; font-size: 14px; }
    .btn { padding: 10px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .btn-primary { background: #611232; color: #fff; }
    .btn-primary:hover { background: #7d1b43; }
    .btn-secondary { background: #e9edf5; color: #333; }
    .btn-blue { background: #2196f3; color: #fff; }
    .btn-blue:hover { background: #0b7dda; }

    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; font-size: 14px; color: #666; padding: 10px 8px; border-bottom: 2px solid #eceff5; }
    tbody td { padding: 8px; border-bottom: 1px solid #f0f2f7; }
    tbody tr:hover { background: #fafbfe; }
    input.table-input { width: 100%; padding: 8px 10px; border: 1px solid #d3d7df; border-radius: 6px; font-size: 14px; }
    
    tbody tr { cursor: pointer; transition: background-color 0.15s ease-in-out; }
    tbody tr.selected {
        background-color: #611232 !important;
        color: white;
    }

    .actions { display: flex; gap: 8px; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; }
    .back { text-decoration: none; color: #611232; font-weight: 600; }
    
    .collapsible-header { 
      cursor: pointer; 
      margin-top: 18px; 
      user-select: none;
      font-size: 16px;
      font-weight: 700;
      color: #2a1a2e;
      padding: 12px 16px;
      border-radius: 8px;
      transition: all 0.28s ease;
      border-left: 4px solid #611232;
      border-bottom: 1px solid transparent;
    }
    
    .collapsible-header:hover {
      background: rgba(97, 18, 50, 0.04);
      border-left-color: #7d1b43;
    }
    .collapsible { margin-top: 12px; }
    
    .search-row { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; }
    .search-row input { flex: 1; padding: 10px 12px; border: 1px solid #d3d7df; border-radius: 8px; font-size: 14px; }
    .search-row button { padding: 10px 16px; }
    
    .message { padding: 12px; border-radius: 8px; margin-bottom: 12px; font-weight: 600; }
    .message.success { background: #d4edda; color: #155724; }
    .message.error { background: #f8d7da; color: #721c24; }

    /* Estilos modernos para la sección de descargas */
    .descargas-section {
      background: linear-gradient(to bottom, #fafbfc 0%, #ffffff 100%);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .descargas-toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      position: relative;
      flex: 1 1 320px;
      min-width: 0;
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: #999;
      pointer-events: none;
    }

    .search-box input {
      width: 100%;
      padding: 12px 14px 12px 42px;
      border: 2px solid #e8eaed;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: white;
      box-sizing: border-box;
    }

    .search-box input:focus {
      outline: none;
      border-color: #611232;
      box-shadow: 0 0 0 3px rgba(97, 18, 50, 0.1);
    }

    .date-filters {
      display: flex;
      gap: 8px;
      flex: 1 1 260px;
      min-width: 0;
      flex-wrap: wrap;
    }

    .date-filters input {
      padding: 12px 14px;
      border: 2px solid #e8eaed;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: white;
      box-sizing: border-box;
    }

    .date-filters input:focus {
      outline: none;
      border-color: #611232;
      box-shadow: 0 0 0 3px rgba(97, 18, 50, 0.1);
    }

    .status-filter {
      padding: 12px 14px;
      border: 2px solid #e8eaed;
      border-radius: 10px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    .status-filter:focus {
      outline: none;
      border-color: #611232;
      box-shadow: 0 0 0 3px rgba(97, 18, 50, 0.1);
    }

    .descargas-actions {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 20px;
      padding: 16px;
      background: white;
      border-radius: 10px;
      border: 2px solid #f0f2f5;
    }

    .actions-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-icon {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      text-decoration: none;
      background: #f5f7fa;
      color: #333;
    }

    .btn-icon:hover {
      background: #e8eaed;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-icon svg {
      flex-shrink: 0;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .descargas-table-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      border: 2px solid #f0f2f5;
    }

    .modern-table {
      width: 100%;
      border-collapse: collapse;
    }

    .modern-table thead {
      background: linear-gradient(to bottom, #f8f9fa, #f0f2f5);
      border-bottom: 2px solid #e0e3e7;
    }

    .modern-table thead th {
      text-align: left;
      font-size: 13px;
      font-weight: 700;
      color: #495057;
      padding: 16px 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .modern-table tbody tr {
      cursor: pointer;
      transition: all 0.15s ease;
      border-bottom: 1px solid #f0f2f5;
    }

    .modern-table tbody tr:hover {
      background: #f8f9fb;
      transform: scale(1.001);
    }

    .modern-table tbody tr.selected {
      background: linear-gradient(to right, #611232, #7d1b43) !important;
      color: white;
      box-shadow: 0 2px 8px rgba(97, 18, 50, 0.3);
    }

    .modern-table tbody td {
      padding: 16px 14px;
      font-size: 14px;
      color: #495057;
      vertical-align: middle;
    }

    .modern-table tbody tr.selected td {
      color: white;
    }

    .modern-table .status-col {
      width: 120px;
    }

    .modern-table .price-col {
      width: 100px;
      font-weight: 600;
    }

    .modern-table tbody td:first-child {
      font-weight: 600;
      padding-left: 20px;
    }

    .descargas-pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 24px;
      padding: 16px;
      background: white;
      border-radius: 10px;
      border: 2px solid #f0f2f5;
    }

    .descargas-pagination .page-info {
      font-weight: 600;
      color: #495057;
      font-size: 14px;
      padding: 8px 16px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .descargas-pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .descargas-pagination button:disabled:hover {
      background: #e9edf5;
      transform: none;
    }

    /* Estilos para la sección de historial de saldos */
    .saldos-section {
      background: linear-gradient(to bottom, #fafbfc 0%, #ffffff 100%);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .saldos-toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .saldos-table-container {
      overflow-x: auto;
      border-radius: 10px;
      border: 2px solid #f0f2f5;
      margin-bottom: 20px;
    }

    #saldosTable {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    #saldosTable thead {
      background: linear-gradient(to bottom, #f8f9fa 0%, #f0f2f5 100%);
      border-bottom: 2px solid #e8eaed;
    }

    #saldosTable th {
      padding: 14px;
      text-align: left;
      font-weight: 600;
      color: #495057;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #saldosTable td {
      padding: 14px;
      border-bottom: 1px solid #f0f2f5;
      color: #333;
      font-size: 14px;
    }

    #saldosTable tbody tr {
      transition: background-color 0.2s ease;
    }

    #saldosTable tbody tr:hover {
      background-color: #f9fafb;
    }

    #saldosTable tbody tr.selected {
      background-color: #e7f3ff;
    }

    #saldosTable tbody tr.selected td {
      color: #0066cc;
    }

    #saldosTable input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #611232;
    }

    .saldos-pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 24px;
      padding: 16px;
      background: white;
      border-radius: 10px;
      border: 2px solid #f0f2f5;
    }

    .saldos-pagination .page-info {
      font-weight: 600;
      color: #495057;
      font-size: 14px;
      padding: 8px 16px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .saldos-pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .saldos-pagination button:disabled:hover {
      background: #e9edf5;
      transform: none;
    }

    /* Responsividad para móviles y tablets */
    .descargas-toolbar > * { min-width: 0; }
    .saldos-toolbar > * { min-width: 0; }

    @media (max-width: 992px) {
      .container { max-width: 100%; }
    }

    @media (max-width: 768px) {
      body { padding: 16px; }
      .container { padding: 16px; }
      .top-bar { flex-direction: column; align-items: flex-start; gap: 8px; }

      /* Formularios principales */
      .form-inline { grid-template-columns: 1fr; }

      /* Toolbar de descargas en columna */
      .descargas-toolbar { flex-direction: column; align-items: stretch; gap: 10px; }
      .search-box, .date-filters, .status-filter, #descargasFilterBtn, #descargasResetBtn { width: 100%; }
      .date-filters { flex-direction: column; }

      /* Acciones */
      .descargas-actions { justify-content: stretch; }
      .actions-right { width: 100%; }
      .actions-right .btn-icon, .actions-right .btn-danger { flex: 1; justify-content: center; }

      /* Tabla y paginación */
      .descargas-table-container { overflow-x: auto; }
      .modern-table thead th, .modern-table tbody td { padding: 12px 10px; font-size: 13px; }
      .descargas-pagination { flex-wrap: wrap; gap: 10px; }
      .descargas-pagination .btn { flex: 1 1 140px; }

      /* USUARIOS - Responsive para móviles */
      .usuarios-table-container { overflow-x: auto; }
      
      #usuariosTable {
        font-size: 13px;
      }

      #usuariosTable thead {
        display: none;
      }

      #usuariosTable tbody tr {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 12px;
        border: 1px solid #e0e3e8;
        border-radius: 8px;
        margin-bottom: 12px;
        background: #fafbfc;
      }

      #usuariosTable tbody td {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 8px;
        align-items: center;
        padding: 6px 0;
        border: none;
      }

      #usuariosTable tbody td:before {
        content: attr(data-label);
        font-weight: 600;
        color: #611232;
        font-size: 12px;
        text-transform: uppercase;
      }

      #usuariosTable tbody tr:hover {
        background: #fff;
        border-color: #611232;
      }

      .search-row {
        flex-direction: column;
        align-items: stretch;
      }

      .search-row input,
      .search-row button {
        width: 100%;
      }

      #usuariosPaginacion {
        flex-wrap: wrap !important;
        gap: 6px !important;
      }

      #usuariosPaginacion button {
        flex: 1 1 calc(25% - 5px);
        padding: 8px 4px !important;
        font-size: 12px !important;
      }

      input.usuario-password {
        font-size: 12px;
      }
    }

    @media (max-width: 480px) {
      #usuariosTable tbody td {
        grid-template-columns: 100px 1fr;
      }

      #usuariosTable tbody td:before {
        font-size: 11px;
      }

      .btn-danger {
        padding: 6px 8px;
        width: 100%;
      }

      .btn-danger svg {
        width: 14px;
        height: 14px;
      }

      /* SERVICIOS - Responsive para móviles */
      #nuestrosServiciosCollapse table {
        font-size: 13px;
      }

      #nuestrosServiciosCollapse thead {
        display: none;
      }

      #nuestrosServiciosCollapse tbody tr {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 12px;
        border: 1px solid #e0e3e8;
        border-radius: 8px;
        margin-bottom: 12px;
        background: #fafbfc;
      }

      #nuestrosServiciosCollapse tbody td {
        display: grid;
        grid-template-columns: 100px 1fr;
        gap: 8px;
        align-items: center;
        padding: 6px 0;
        border: none;
      }

      #nuestrosServiciosCollapse tbody td:before {
        content: attr(data-label);
        font-weight: 600;
        color: #611232;
        font-size: 12px;
        text-transform: uppercase;
      }

      #nuestrosServiciosCollapse tbody tr:hover {
        background: #fff;
        border-color: #611232;
      }

      #nuestrosServiciosCollapse .actions {
        display: flex !important;
        gap: 8px;
        grid-column: 1 / -1;
        margin-top: 8px;
      }

      #nuestrosServiciosCollapse .actions button {
        flex: 1;
        padding: 8px !important;
        font-size: 12px !important;
      }

      /* PROVEEDORES - Responsive para móviles */
      #proveedoresTable {
        font-size: 13px;
      }

      #proveedoresTable thead {
        display: none;
      }

      #proveedoresTable tbody tr {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 12px;
        border: 1px solid #e0e3e8;
        border-radius: 8px;
        margin-bottom: 12px;
        background: #fafbfc;
      }

      #proveedoresTable tbody td {
        display: grid;
        grid-template-columns: 110px 1fr;
        gap: 8px;
        align-items: center;
        padding: 6px 0;
        border: none;
      }

      #proveedoresTable tbody td:before {
        content: attr(data-label);
        font-weight: 600;
        color: #611232;
        font-size: 12px;
        text-transform: uppercase;
      }

      #proveedoresTable tbody td:last-child {
        grid-template-columns: 1fr;
      }

      #proveedoresTable tbody td:last-child:before {
        content: "Acciones";
        display: block;
        margin-bottom: 4px;
      }

      #proveedoresTable tbody td:last-child {
        display: flex !important;
        flex-wrap: wrap;
        gap: 8px;
      }

      #proveedoresTable tbody tr:hover {
        background: #fff;
        border-color: #611232;
      }

      .prov-actions-container {
        display: flex;
        gap: 8px;
        width: 100%;
      }

      .prov-actions-container button {
        flex: 1;
        padding: 8px !important;
        font-size: 12px !important;
      }

      /* Form inline responsive */
      .form-inline {
        grid-template-columns: 1fr !important;
      }
    }

    @media (max-width: 480px) {
      /* SERVICIOS - Ultra pequeño */
      #nuestrosServiciosCollapse tbody td {
        grid-template-columns: 90px 1fr;
      }

      #nuestrosServiciosCollapse tbody td:before {
        font-size: 11px;
      }

      #nuestrosServiciosCollapse .actions button {
        padding: 6px 4px !important;
        font-size: 11px !important;
      }

      /* PROVEEDORES - Ultra pequeño */
      #proveedoresTable tbody td {
        grid-template-columns: 85px 1fr;
      }

      #proveedoresTable tbody td:before {
        font-size: 11px;
      }

      .prov-actions-container button {
        padding: 6px 4px !important;
        font-size: 11px !important;
      }

      input.table-input {
        font-size: 12px;
        padding: 6px 8px !important;
      }
    }

    /* ESTILOS PARA TRÁMITES PROCESADOS */
    .tramites-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .tramites-toolbar {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tramites-table-container {
      overflow-x: auto;
      margin: 12px 0;
    }

    .tramites-pagination {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .tramites-pagination .btn {
      min-width: 100px;
    }

    .page-info {
      padding: 0 12px;
      color: #666;
      font-size: 14px;
    }

    /* Estilos para botones de acción */
    .btn-icon {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #2196f3;
      color: white;
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s ease;
    }

    .btn-icon:hover {
      background: #0b7dda;
    }

    .btn-danger {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e74c3c;
      color: white;
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s ease;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    /* Tabla moderna */
    .modern-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    .modern-table thead th {
      background: #f5f7fa;
      color: #333;
      font-weight: 600;
      padding: 12px;
      text-align: left;
      border-bottom: 2px solid #e0e3e8;
    }

    .modern-table tbody tr {
      transition: background-color 0.15s ease-in-out;
    }

    .modern-table tbody tr:hover {
      background: #fafbfe;
    }

    .modern-table tbody tr.selected {
      background: #611232 !important;
      color: white;
    }

    .modern-table tbody td {
      padding: 12px;
      border-bottom: 1px solid #f0f2f7;
    }

    .modern-table tbody tr.selected td {
      color: white;
    }

    /* Responsividad para tabla de trámites */
    @media (max-width: 768px) {
      .tramites-toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .tramites-toolbar > div {
        flex-direction: column;
        align-items: stretch;
      }

      .tramites-toolbar input,
      .tramites-toolbar button {
        width: 100%;
      }

      .tramites-actions {
        flex-direction: column !important;
        align-items: stretch !important;
      }

      .tramites-actions button {
        width: 100%;
      }

      .modern-table {
        font-size: 13px;
      }

      .modern-table thead {
        display: none;
      }

      /* ===== ESTILOS HORARIOS Y AVISOS ===== */
      .horarios-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(520px, 1fr));
        gap: 24px;
        margin-bottom: 20px;
      }

      .horario-card {
        background: #fff;
        border: 1px solid #e0e6f0;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 12px rgba(97, 18, 50, 0.08), 0 1px 3px rgba(0, 0, 0, 0.02);
        transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        border-left: 5px solid #611232;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto auto;
        gap: 18px;
        position: relative;
        overflow: hidden;
      }

      .horario-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 60px;
        height: 60px;
        background: radial-gradient(circle, rgba(97, 18, 50, 0.03) 0%, transparent 70%);
        border-radius: 0 12px 0 40%;
      }

      .horario-card:hover {
        box-shadow: 0 12px 32px rgba(97, 18, 50, 0.15), 0 2px 8px rgba(0, 0, 0, 0.04);
        transform: translateY(-4px);
        border-color: #611232;
      }

      .horario-card h4 {
        color: #2a1a2e;
        font-size: 17px;
        margin: 0;
        font-weight: 700;
        text-transform: capitalize;
        grid-column: 1 / -1;
        padding-bottom: 12px;
        border-bottom: 2px solid #f0f0f0;
        letter-spacing: -0.3px;
      }

      .form-group-horario {
        margin: 0;
        display: flex;
        flex-direction: column;
      }

      .form-group-horario.full-width {
        grid-column: 1 / -1;
      }

      .form-group-horario label {
        display: block;
        font-size: 10.5px;
        color: #7a7a8e;
        margin-bottom: 8px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.8px;
      }

      .form-group-horario input,
      .form-group-horario textarea {
        width: 100%;
        padding: 11px 14px;
        border: 1.5px solid #e0e6f0;
        border-radius: 8px;
        font-size: 13.5px;
        font-family: 'Segoe UI', Tahoma, sans-serif;
        transition: all 0.28s ease;
        background: linear-gradient(135deg, #fafbfc 0%, #f5f6f9 100%);
        box-sizing: border-box;
        color: #2a2a3e;
      }

      .form-group-horario input::placeholder,
      .form-group-horario textarea::placeholder {
        color: #a8aab8;
        font-style: normal;
      }

      .form-group-horario input:hover {
        border-color: #d0d8e8;
        background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
      }

      .form-group-horario input:focus,
      .form-group-horario textarea:focus {
        outline: none;
        border-color: #611232;
        background: #ffffff;
        box-shadow: 0 0 0 4px rgba(97, 18, 50, 0.12), inset 0 1px 2px rgba(0, 0, 0, 0.02);
      }

      .form-group-horario textarea {
        resize: vertical;
        min-height: 68px;
        font-family: 'Segoe UI', Tahoma, sans-serif;
        line-height: 1.5;
      }

      .form-group-horario textarea:hover {
        border-color: #d0d8e8;
        background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
        padding: 10px 12px;
        background: linear-gradient(135deg, #f8f9fc 0%, #f3f4f9 100%);
        border-radius: 8px;
        border: 1.5px solid #e8ecf5;
        transition: all 0.28s ease;
      }

      .checkbox-group:hover {
        border-color: #d8dde8;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fc 100%);
      }

      .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #611232;
        flex-shrink: 0;
      }

      .checkbox-group label {
        margin: 0;
        cursor: pointer;
        font-size: 13px;
        color: #4a4a5e;
        font-weight: 600;
      }

      .horario-checkboxes {
        grid-column: 1 / -1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }

      /* Media queries para sección de horarios */
      @media (max-width: 1200px) {
        .horarios-grid {
          grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
        }
      }

      @media (max-width: 992px) {
        .horarios-grid {
          grid-template-columns: 1fr;
        }

        .horario-card {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto auto auto auto;
        }

        .horario-checkboxes {
          grid-column: 1 / -1;
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .horarios-grid {
          gap: 16px;
        }

        .horario-card {
          padding: 16px;
          gap: 12px;
        }

        .checkbox-group {
          padding: 6px 8px;
          font-size: 11px;
        }

        .checkbox-group input[type="checkbox"] {
          width: 14px;
          height: 14px;
        }
      }

      .modern-table {
        font-size: 13px;
      }

      .modern-table thead {
        display: none;
      }

      .modern-table tbody tr {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 12px;
        border: 1px solid #e0e3e8;
        border-radius: 8px;
        margin-bottom: 12px;
        background: #fafbfc;
      }

      .modern-table tbody td {
        display: grid;
        grid-template-columns: 100px 1fr;
        gap: 8px;
        align-items: center;
        padding: 6px 0;
        border: none;
      }

      .modern-table tbody td:before {
        content: attr(data-label);
        font-weight: 600;
        color: #611232;
        font-size: 12px;
        text-transform: uppercase;
      }

      .modern-table tbody tr:hover {
        background: #fff;
        border-color: #611232;
      }

      .modern-table tbody tr.selected {
        background: #611232 !important;
      }

      .modern-table tbody tr.selected td {
        color: white;
      }

      .modern-table tbody tr.selected td:before {
        color: white;
      }

      .tramites-pagination {
        flex-wrap: wrap;
        gap: 6px;
      }

      .tramites-pagination .btn {
        flex: 1 1 calc(33% - 5px);
        min-width: auto;
      }

      .page-info {
        flex: 1 1 100%;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <h1>Panel de administración</h1>
      <a class="back" href="{{ url_for('index') }}">← Volver</a>
    </div>

    <!-- SECCIÓN SALDOS -->
    <h3 class="collapsible-header">Saldos ▾</h3>
    <div class="collapsible" id="saldosCollapse" style="display:none; margin-top:12px;">
      <div style="padding:12px; background:#f8f9fa; border-radius:8px;">
        <div class="search-row">
          <input id="saldoSearchInput" type="text" placeholder="Buscar por correo o celular..." />
          <button class="btn btn-blue" onclick="buscarSaldos()">Buscar</button>
          <button class="btn btn-secondary" onclick="limpiarSaldos()">Limpiar</button>
        </div>
        
        <div id="saldoMessage" style="display:none;"></div>
        
        <table id="saldosResultTable" style="display:none;">
          <thead>
            <tr>
              <th>Correo</th>
              <th style="width: 140px;">Saldo Actual</th>
              <th style="width: 140px;">Agregar Saldo</th>
              <th style="width: 100px;">Acción</th>
            </tr>
          </thead>
          <tbody id="saldosResultBody">
          </tbody>
        </table>
      </div>
    </div>

    <!-- SECCIÓN USUARIOS -->
    <h3 class="collapsible-header">Usuarios ▾</h3>
    <div class="collapsible" id="usuariosCollapse" style="display:none; margin-top:12px;">
      <div style="padding:12px; background:#f8f9fa; border-radius:8px;">
        <div class="search-row">
          <input id="usuariosSearchInput" type="text" placeholder="Buscar por celular, correo..." />
          <button class="btn btn-secondary" onclick="limpiarFiltrosUsuarios()">Limpiar</button>
        </div>
        
        <div id="usuariosMessage" style="display:none;"></div>
        
        <table id="usuariosTable">
          <thead>
            <tr>
              <th>Celular</th>
              <th>Correo</th>
              <th>Contraseña</th>
              <th style="width: 100px;">Saldo</th>
              <th style="width: 50px;">Acción</th>
            </tr>
          </thead>
          <tbody id="usuariosTableBody">
            <tr><td colspan="5" class="vacio">Cargando usuarios...</td></tr>
          </tbody>
        </table>
        
        <div id="usuariosPaginacion" style="display:flex;justify-content:center;align-items:center;gap:8px;margin:16px 0;"></div>
      </div>
    </div>

    <!-- SECCIÓN NUESTROS SERVICIOS (UNIFICADA: formulario + lista) -->
    <h3 class="collapsible-header">Nuestros servicios ▾</h3>
    <div class="collapsible" id="nuestrosServiciosCollapse" style="display:none; margin-top:12px;">
      <!-- Formulario para crear nuevo trámite (mantiene orden original: formulario arriba) -->
      <form class="form-inline" method="POST" action="{{ url_for('crear_tramite') }}">
        <input type="text" name="tramite" placeholder="Nombre del trámite" required />
        <input type="number" step="0.01" name="precio" placeholder="Precio" required />
        <input type="text" name="tiempo" placeholder="Tiempo (p.e. 5-30 MIN)" required />
        <button class="btn btn-primary" type="submit">Guardar</button>
      </form>

      <!-- Tabla de trámites existentes (mantiene funcionalidad y orden) -->
      <div style="margin-top:14px;">
        <table>
          <thead>
            <tr>
              <th style="width: 60px;">ID</th>
              <th>Trámite</th>
              <th style="width: 140px;">Precio</th>
              <th style="width: 200px;">Tiempo</th>
              <th style="width: 120px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for t in tramites %}
            <tr>
              <td data-label="ID">{{ t.id }}</td>
              <td data-label="Trámite">
                <form method="POST" action="{{ url_for('actualizar_tramite', tramite_id=t.id) }}">
                  <input class="table-input" type="text" name="tramite" value="{{ t.tramite }}" />
              </td>
              <td data-label="Precio">
                  <input class="table-input" type="number" step="0.01" name="precio" value="{{ '%.2f'|format(t.precio) }}" />
              </td>
              <td data-label="Tiempo">
                  <input class="table-input" type="text" name="tiempo" value="{{ t.tiempo }}" />
              </td>
              <td class="actions" data-label="Acciones">
                  <button class="btn btn-secondary" type="submit">Cambiar</button>
                  <button class="btn btn-danger btn-eliminar-tramite" type="button" data-id="{{ t.id }}" title="Eliminar"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5">No hay trámites registrados.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- SECCIÓN PROVEEDORES -->
    <h3 class="collapsible-header">Proveedores ▾</h3>
    <div class="collapsible" id="proveedoresCollapse" style="display:none; margin-top:12px;">
      <div style="padding:12px; background:#f8f9fa; border-radius:8px;">
        <label style="display:block; font-weight:600; margin-bottom:8px;">Agregar proveedor / usuario</label>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
          <div style="position:relative;">
            <input id="prov_celular" type="tel" placeholder="Celular (10 dígitos)" class="input-modern" style="padding-left:38px;" />
            <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#611232;font-size:18px;">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 16.92V19a2 2 0 0 1-2.18 2A19.86 19.86 0 0 1 3 5.18 2 2 0 0 1 5 3h2.09a2 2 0 0 1 2 1.72c.13 1.06.37 2.09.72 3.08a2 2 0 0 1-.45 2.11l-.27.27a16 16 0 0 0 6.58 6.58l.27-.27a2 2 0 0 1 2.11-.45c.99.35 2.02.59 3.08.72A2 2 0 0 1 21 16.92z"/></svg>
            </span>
          </div>
          <div style="position:relative;">
            <input id="prov_correo" type="email" placeholder="Correo" class="input-modern" style="padding-left:38px;" />
            <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#611232;font-size:18px;">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="22,6 12,13 2,6"/></svg>
            </span>
          </div>
          <div style="position:relative;">
            <input id="prov_password" type="password" placeholder="Contraseña" class="input-modern" style="padding-left:38px;" />
            <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#611232;font-size:18px;">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            </span>
          </div>
          <div>
            <select id="prov_role" class="input-modern">
              <option value="0">Usuario normal</option>
              <option value="1">Administrador</option>
              <option value="2">Proveedor</option>
            </select>
          </div>
        </div>
            <style>
              .input-modern {
                width: 100%;
                padding: 12px 14px;
                border: 2px solid #e8eaed;
                border-radius: 10px;
                font-size: 15px;
                background: #f8f9fa;
                transition: all 0.2s;
                box-sizing: border-box;
                outline: none;
              }
              .input-modern:focus {
                border-color: #611232;
                background: #fff;
                box-shadow: 0 0 0 3px rgba(97,18,50,0.08);
              }
              #prov_role.input-modern {
                padding-left: 14px;
              }
            </style>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button id="provGuardar" class="btn btn-primary">Guardar</button>
          <div id="provMsg" style="align-self:center;color:#666;font-size:14px;"></div>
        </div>
      </div>

      <!-- Tabla de Proveedores Registrados -->
      <div style="margin-top:20px;">
        <h4 style="color:#333; margin-bottom:12px;">Proveedores registrados</h4>
        <table id="proveedoresTable">
          <thead>
            <tr>
              <th style="width: 60px;">ID</th>
              <th style="width: 150px;">Celular</th>
              <th style="width: 200px;">Correo</th>
              <th style="width: 180px;">Nueva Contraseña</th>
              <th style="width: 120px;">Acciones</th>
            </tr>
          </thead>
          <tbody id="proveedoresTbody">
            <tr>
              <td colspan="5" style="text-align:center; color:#999;">Cargando proveedores...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- SECCIÓN REGISTRO DE DESCARGAS -->
    <h3 class="collapsible-header">Registro de descargas ▾</h3>
    <div class="collapsible" id="descargasCollapse" style="display:none; margin-top:12px;">
      <div class="descargas-section">
        <!-- Barra de búsqueda y filtros -->
        <div class="descargas-toolbar" style="display: flex; flex-direction: column; gap: 10px;">
          <!-- Primera fila: búsqueda y fechas -->
          <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <div class="search-box" style="flex:2; min-width:160px; display:flex; align-items:center;">
              <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <input type="text" id="descargasSearchInput" class="input-modern" placeholder="Buscar por identificador, trámite o usuario..." style="width:100%;">
            </div>
            <input type="date" id="descargasDateFrom" class="input-modern" placeholder="Desde" style="min-width:120px;">
            <input type="date" id="descargasDateTo" class="input-modern" placeholder="Hasta" style="min-width:120px;">
          </div>
          <!-- Segunda fila: estado, filtrar y limpiar -->
          <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <select id="descargasStatusFilter" class="input-modern" style="flex:1; min-width:120px;">
              <option value="">Todos los estados</option>
              <option value="1">Pendiente</option>
              <option value="2">Éxito</option>
              <option value="3">Sin éxito</option>
            </select>
            <button id="descargasFilterBtn" class="btn btn-primary" style="flex:1; min-width:100px; display:flex; align-items:center; gap:4px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
              </svg>
              Filtrar
            </button>
            <button id="descargasResetBtn" class="btn btn-secondary" style="flex:1; min-width:100px;">Limpiar</button>
          </div>
        </div>
        <!-- Fin barra de búsqueda y filtros -->

        <!-- Barra de acciones -->
        <div class="descargas-actions">
          <div class="actions-right">
            <a href="/admin/backup" class="btn btn-icon" title="Respaldar DB">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Respaldar
            </a>
            <button id="descargasExportCsvBtn" class="btn btn-icon" title="Exportar CSV">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="12" y1="18" x2="12" y2="12"/>
                <line x1="9" y1="15" x2="15" y2="15"/>
              </svg>
              Exportar
            </button>
            <button id="descargasDeleteSelectedBtn" class="btn btn-danger" title="Eliminar seleccionados">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
              Eliminar seleccionados
            </button>
            <button id="descargasDeleteFilteredBtn" class="btn btn-danger" title="Eliminar filtrados">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
              </svg>
              Eliminar filtrados
            </button>
          </div>
        </div>

        <!-- Tabla de descargas -->
        <div class="descargas-table-container">
          <div class="descargas-info" style="margin-bottom: 12px; font-size: 14px; color: #666; display: flex; justify-content: space-between; align-items: center;">
            <span id="descargasRecordCount">Total: 0 registros</span>
          </div>
          <table id="descargasTable" class="modern-table">
            <thead>
              <tr>
                <th class="status-col">Estado</th>
                <th>Identificador</th>
                <th>Trámite</th>
                <th>Usuario</th>
                <th>Fecha</th>
                <th class="price-col">Precio</th>
              </tr>
            </thead>
            <tbody id="descargasTbody">
              <!-- Los datos se cargarán aquí con JS -->
            </tbody>
          </table>
        </div>
        
        <!-- Paginación -->
        <div class="descargas-pagination">
          <button id="descargasPrevPage" class="btn btn-secondary">← Anterior</button>
          <span id="descargasPageInfo" class="page-info">Página 1 de 1</span>
          <button id="descargasNextPage" class="btn btn-secondary">Siguiente →</button>
        </div>
      </div>
    </div>

    <!-- SECCIÓN HISTORIAL DE SALDOS -->
    <h3 class="collapsible-header">Historial de saldos ▾</h3>
    <div class="collapsible" id="saldosCollapse" style="display:none; margin-top:12px;">
      <div class="saldos-section">
        <!-- Barra de herramientas -->
        <div class="saldos-toolbar" style="display: flex; flex-direction: column; gap: 10px;">
          <!-- Primera fila: búsqueda y fechas -->
          <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <div class="search-box" style="flex:2; min-width:160px; display:flex; align-items:center;">
              <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <input type="text" id="saldosSearchInput" class="input-modern" placeholder="Buscar por usuario (email)..." style="width:100%;">
            </div>
            <input type="date" id="saldosDateFrom" class="input-modern" placeholder="Desde" style="min-width:120px;">
            <input type="date" id="saldosDateTo" class="input-modern" placeholder="Hasta" style="min-width:120px;">
          </div>
          <!-- Segunda fila: botones de acción -->
          <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <button id="saldosFilterBtn" class="btn btn-primary" style="flex:1; min-width:100px; display:flex; align-items:center; gap:4px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
              </svg>
              Filtrar
            </button>
            <button id="saldosResetBtn" class="btn btn-secondary" style="flex:1; min-width:100px;">Limpiar</button>
            <button id="saldosExportCsvBtn" class="btn btn-secondary" style="flex:1; min-width:100px; display:flex; align-items:center; gap:4px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Descargar CSV
            </button>
            <button id="saldosDeleteSelectedBtn" class="btn btn-danger" title="Eliminar seleccionados">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
              Eliminar seleccionados
            </button>
            <button id="saldosDeleteFilteredBtn" class="btn btn-danger" title="Eliminar filtrados">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
              </svg>
              Eliminar filtrados
            </button>
          </div>
        </div>

        <!-- Tabla de historial de saldos -->
        <div class="saldos-table-container">
          <table id="saldosTable" class="modern-table">
            <thead>
              <tr>
                <th style="width: 30px;"><input type="checkbox" id="saldosSelectAll" /></th>
                <th>ID</th>
                <th>Usuario</th>
                <th>Abono</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody id="saldosTbody">
              <!-- Los datos se cargarán aquí con JS -->
            </tbody>
          </table>
        </div>
        
        <!-- Paginación -->
        <div class="saldos-pagination">
          <button id="saldosPrevPage" class="btn btn-secondary">← Anterior</button>
          <span id="saldosPageInfo" class="page-info">Página 1 de 1</span>
          <button id="saldosNextPage" class="btn btn-secondary">Siguiente →</button>
        </div>
      </div>
    </div>

    <!-- SECCIÓN TRÁMITES PROCESADOS -->
    <h3 class="collapsible-header">Trámites procesados ▾</h3>
    <div class="collapsible" id="tramitesCollapse" style="display:none; margin-top:12px;">
      <div class="tramites-section">
        <!-- Barra de búsqueda y filtros -->
        <div class="tramites-toolbar" style="display: flex; flex-direction: column; gap: 10px;">
          <!-- Primera fila: búsqueda y fechas -->
          <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <div class="search-box" style="flex:2; min-width:160px; display:flex; align-items:center;">
              <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <input type="text" id="tramitesSearchInput" class="input-modern" placeholder="Buscar por identificador, trámite..." style="width:100%;">
            </div>
            <input type="date" id="tramitesDateFrom" class="input-modern" placeholder="Desde" style="min-width:120px;">
            <input type="date" id="tramitesDateTo" class="input-modern" placeholder="Hasta" style="min-width:120px;">
          </div>
          <!-- Segunda fila: botones filtrar y limpiar -->
          <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <button id="tramitesFilterBtn" class="btn btn-primary" style="flex:1; min-width:100px; display:flex; align-items:center; gap:4px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
              </svg>
              Filtrar
            </button>
            <button id="tramitesResetBtn" class="btn btn-secondary" style="flex:1; min-width:100px;">Limpiar</button>
          </div>
        </div>

        <!-- Barra de acciones -->
        <div class="tramites-actions" style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: flex-end; margin-top: 12px;">
          <button id="tramitesBackupBtn" class="btn btn-icon" title="Respaldar DB">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Respaldar
          </button>
          <button id="tramitesExportCsvBtn" class="btn btn-icon" title="Exportar CSV">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="12" y1="18" x2="12" y2="12"/>
              <line x1="9" y1="15" x2="15" y2="15"/>
            </svg>
            Exportar
          </button>
          <button id="tramitesDeleteSelectedBtn" class="btn btn-danger" title="Eliminar seleccionados">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Eliminar
          </button>
          <button id="tramitesDeleteFilteredBtn" class="btn btn-danger" title="Eliminar filtrados">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              <line x1="10" y1="11" x2="10" y2="17"/>
              <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
            Eliminar filtrados
          </button>
        </div>

        <!-- Tabla de trámites procesados -->
        <div class="tramites-table-container" style="margin-top: 12px; overflow-x: auto;">
          <table id="tramitesTable" class="modern-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="tramitesSelectAll" style="width:18px; height:18px;"></th>
                <th>Identificador</th>
                <th>Trámite</th>
                <th>Solicitud</th>
                <th>Atención</th>
              </tr>
            </thead>
            <tbody id="tramitesTbody">
              <!-- Los datos se cargarán aquí con JS -->
            </tbody>
          </table>
        </div>
        
        <!-- Paginación -->
        <div class="tramites-pagination" style="display: flex; gap: 8px; justify-content: center; margin-top: 12px; align-items: center;">
          <button id="tramitesPrevPage" class="btn btn-secondary">← Anterior</button>
          <span id="tramitesPageInfo" class="page-info">Página 1 de 1</span>
          <button id="tramitesNextPage" class="btn btn-secondary">Siguiente →</button>
        </div>
      </div>
    </div>

    <!-- SECCIÓN HORARIOS Y AVISOS -->
    <h3 class="collapsible-header">Horarios y Avisos ▾</h3>
    <div class="collapsible" id="horariosCollapse" style="display:none; margin-top:12px;">
      <div style="background: linear-gradient(135deg, #fafbfd 0%, #f5f6fa 100%); padding: 28px; border-radius: 12px; border: 1px solid #e0e6f0; box-shadow: inset 0 1px 3px rgba(0,0,0,0.02);">
        <div id="horariosContainer" class="horarios-grid">
          <!-- Las tarjetas de horarios se cargarán aquí -->
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e0e6f0;">
          <button id="guardarHorariosBtn" class="btn btn-primary" style="padding: 11px 32px; font-weight: 600; border-radius: 8px; box-shadow: 0 2px 8px rgba(97, 18, 50, 0.15);">
            💾 Guardar cambios
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Modal para confirmaciones -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true" style="display:none;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">Confirmar acción</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="confirmModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmModalOk">Confirmar</button>
      </div>
    </div>
  </div>
</div>

  <!-- Bootstrap Toasts para mensajes -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 20000;">
  <div id="mainToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="mainToastBody"></div>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Toggle all collapsible sections
    let selectedIds = new Set();
    let lastSelectedId = null;

    document.querySelectorAll('.collapsible-header').forEach(function(h){
      h.addEventListener('click', function(){
        const next = h.nextElementSibling;
        if (!next) return;
        if (next.style.display === 'none' || next.style.display === '') { 
          next.style.display = 'block'; 
          h.innerText = h.innerText.replace('▾','▴'); 
        }
        else { 
          next.style.display = 'none'; 
          h.innerText = h.innerText.replace('▴','▾'); 
        }
      });
    });

    // URLs de las rutas
    const urls = {
      buscarUsuarios: '{{ url_for("buscar_usuarios") }}',
      agregarSaldo: '{{ url_for("agregar_saldo") }}',
      obtenerProveedores: '{{ url_for("obtener_proveedores") }}',
      actualizarProveedor: '{{ url_for("actualizar_proveedor") }}',
      crearUsuario: '{{ url_for("crear_usuario") }}',
      apiPedidos: '{{ url_for("api_pedidos") }}',
      exportCsv: '{{ url_for("export_csv") }}',
      deleteFilteredPedidos: '{{ url_for("delete_filtered_pedidos") }}',
      apiTramites: '/api/tramites_procesados',
      eliminarSeleccionadosTramites: '/tramites_procesados/eliminar_seleccionados',
      eliminarFiltradosTramites: '/tramites_procesados/eliminar_filtrados',
      exportarTramitesCsv: '/tramites_procesados/exportar_csv',
      respaldarTramitesDb: '/tramites_procesados/respaldar_db'
    };

    // ========== SALDOS FUNCTIONS ==========
    async function buscarSaldos() {
      const searchText = document.getElementById('saldoSearchInput').value.trim();
      if (!searchText) {
        alert('Por favor ingresa un correo o celular');
        return;
      }
      
      try {
        const resp = await fetch(urls.buscarUsuarios, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ busqueda: searchText })
        });
        const data = await resp.json();
        
        if (data.usuarios && data.usuarios.length > 0) {
          mostrarResultadosSaldos(data.usuarios);
        } else {
          document.getElementById('saldoMessage').innerHTML = '<div class="message error">No se encontraron coincidencias</div>';
          document.getElementById('saldoMessage').style.display = 'block';
          document.getElementById('saldosResultTable').style.display = 'none';
        }
      } catch (e) {
        alert('Error al buscar usuarios');
      }
    }

    function mostrarResultadosSaldos(usuarios) {
      const tbody = document.getElementById('saldosResultBody');
      tbody.innerHTML = usuarios.map(user => `
        <tr>
          <td>${user.correo}</td>
          <td style="display:flex; gap:6px; align-items:center;">
            <input type="number" step="0.01" class="table-input saldo-actual" value="${parseFloat(user.saldo).toFixed(2)}" data-id="${user.id}" min="0" style="width:90px;" />
            <button class="btn btn-blue btn-saldo-guardar" style="padding:6px 10px; font-size:12px;" onclick="guardarSaldoActual(${user.id})">Guardar</button>
          </td>
          <td>
            <input type="number" step="0.01" class="table-input saldo-agregar" value="" data-id="${user.id}" placeholder="0.00" min="0" />
          </td>
          <td>
            <button class="btn btn-primary" style="padding:8px 12px; font-size:12px;" onclick="agregarSaldo(${user.id})">Agregar</button>
          </td>
        </tr>
      `).join('');
      document.getElementById('saldosResultTable').style.display = 'table';
      document.getElementById('saldoMessage').style.display = 'none';
    }
    async function guardarSaldoActual(usuarioId) {
      const inputSaldo = document.querySelector(`.saldo-actual[data-id="${usuarioId}"]`);
      const nuevoSaldo = parseFloat(inputSaldo.value);
      if (isNaN(nuevoSaldo) || nuevoSaldo < 0) {
        Swal.fire({ icon: 'warning', title: 'Saldo inválido', text: 'Ingresa un saldo válido.' });
        return;
      }
      try {
        const resp = await fetch(urls.agregarSaldo, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario_id: usuarioId, monto: nuevoSaldo, set: true })
        });
        const data = await resp.json();
        if (data.success) {
          Swal.fire({ icon: 'success', title: 'Saldo actualizado', text: 'El saldo fue actualizado correctamente.' });
        } else {
          Swal.fire({ icon: 'error', title: 'Error', text: data.message || 'No se pudo actualizar el saldo.' });
        }
      } catch (e) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo actualizar el saldo.' });
      }
    }

    async function agregarSaldo(usuarioId) {
      const inputSaldo = document.querySelector(`.saldo-agregar[data-id="${usuarioId}"]`);
      const montoAgregar = parseFloat(inputSaldo.value);
      
      if (!montoAgregar || montoAgregar <= 0) {
        alert('Por favor ingresa un monto válido');
        return;
      }

      try {
        const resp = await fetch(urls.agregarSaldo, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuario_id: usuarioId, monto: montoAgregar })
        });
        const data = await resp.json();
        
        if (data.success) {
          const fila = inputSaldo.closest('tr');
          const celdasaldo = fila.querySelector('td:nth-child(2)');
          celdasaldo.innerText = '$' + parseFloat(data.nuevo_saldo).toFixed(2);
          
          const msgDiv = document.createElement('div');
          msgDiv.className = 'message success';
          msgDiv.style.marginTop = '12px';
          msgDiv.innerText = 'Saldo agregado correctamente';
          fila.parentNode.insertBefore(msgDiv, fila.nextSibling);
          
          inputSaldo.value = '';
          
          setTimeout(() => msgDiv.remove(), 3000);
          
          // Refrescar saldo del usuario logueado si es el mismo usuario
          if (window.parent && window.parent.refrescarSaldo) {
            window.parent.refrescarSaldo();
          }
        } else {
          alert(data.message || 'Error al agregar saldo');
        }
      } catch (e) {
        alert('Error al agregar saldo');
      }
    }

    function limpiarSaldos() {
      document.getElementById('saldoSearchInput').value = '';
      document.getElementById('saldosResultTable').style.display = 'none';
      document.getElementById('saldoMessage').style.display = 'none';
    }

    // ========== PROVEEDORES FUNCTIONS ==========
    async function cargarProveedores() {
      try {
        const resp = await fetch(urls.obtenerProveedores);
        const data = await resp.json();
        const tbody = document.getElementById('proveedoresTbody');
        
        if (!data.proveedores || data.proveedores.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">No hay proveedores registrados</td></tr>';
          return;
        }

        tbody.innerHTML = data.proveedores.map(prov => `
          <tr>
            <td data-label="ID">${prov.id}</td>
            <td data-label="Celular">
              <input class="table-input prov-celular" type="tel" value="${prov.celular}" data-id="${prov.id}" />
            </td>
            <td data-label="Correo">
              <input class="table-input prov-correo" type="email" value="${prov.correo}" data-id="${prov.id}" />
            </td>
            <td data-label="Nueva Contraseña">
              <input class="table-input prov-password" type="password" placeholder="Dejar en blanco para no cambiar" data-id="${prov.id}" />
            </td>
            <td>
              <div class="prov-actions-container">
                <button class="btn btn-secondary" onclick="guardarCambiosProveedor(${prov.id})">Guardar</button>
                <button class="btn btn-danger btn-eliminar-proveedor" type="button" data-id="${prov.id}" title="Eliminar"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error('Error cargando proveedores:', e);
        document.getElementById('proveedoresTbody').innerHTML = '<tr><td colspan="5" style="color:red;">Error al cargar proveedores</td></tr>';
      }
    }

    async function guardarCambiosProveedor(proveedorId) {
      const celular = document.querySelector(`.prov-celular[data-id="${proveedorId}"]`).value.trim();
      const correo = document.querySelector(`.prov-correo[data-id="${proveedorId}"]`).value.trim();
      const password = document.querySelector(`.prov-password[data-id="${proveedorId}"]`).value;

      if (!celular || !correo) {
        alert('Celular y correo son obligatorios');
        return;
      }

      if (celular.length !== 10 || !/^[0-9]+$/.test(celular)) {
        alert('Celular inválido (debe tener 10 dígitos)');
        return;
      }

      try {
        const resp = await fetch(urls.actualizarProveedor, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ proveedor_id: proveedorId, celular, correo, password })
        });
        const data = await resp.json();
        if (data.success) {
          alert('Cambios guardados exitosamente');
          if (password) {
            document.querySelector(`.prov-password[data-id="${proveedorId}"]`).value = '';
          }
        } else {
          alert(data.message || 'Error al guardar cambios');
        }
      } catch (e) {
        alert('Error de conexión');
      }
    }

    document.getElementById('provGuardar').addEventListener('click', async function(){
      const celular = document.getElementById('prov_celular').value.trim();
      const correo = document.getElementById('prov_correo').value.trim();
      const password = document.getElementById('prov_password').value;
      const role = document.getElementById('prov_role').value;
      const msg = document.getElementById('provMsg');
      msg.style.color = '#666'; msg.textContent = '';

      if (!celular || !correo || !password) { msg.style.color = 'red'; msg.textContent = 'Todos los campos son obligatorios'; return; }
      if (celular.length !== 10 || !/^[0-9]+$/.test(celular)) { msg.style.color = 'red'; msg.textContent = 'Celular inválido'; return; }

      try {
        const resp = await fetch(urls.crearUsuario, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ celular, correo, password, role })
        });
        const data = await resp.json();
        if (data.success) {
          msg.style.color = 'green'; msg.textContent = 'Usuario creado exitosamente';
          document.getElementById('prov_celular').value = '';
          document.getElementById('prov_correo').value = '';
          document.getElementById('prov_password').value = '';
          cargarProveedores();
        } else {
          msg.style.color = 'red'; msg.textContent = data.message || 'Error';
        }
      } catch (e) {
        msg.style.color = 'red'; msg.textContent = 'Error de conexión';
      }
    });

    document.addEventListener('DOMContentLoaded', cargarProveedores);

    // ========== REGISTRO DE DESCARGAS FUNCTIONS ==========
    let descargasCurrentPage = 1;

    async function fetchPedidos(page = 1) {
      const search = document.getElementById('descargasSearchInput').value.trim();
      const dateFrom = document.getElementById('descargasDateFrom').value;
      const dateTo = document.getElementById('descargasDateTo').value;
      const statusFilter = document.getElementById('descargasStatusFilter').value;

      const params = new URLSearchParams({ page, search, date_from: dateFrom, date_to: dateTo, status: statusFilter });
      const url = urls.apiPedidos + '?' + params;

      try {
        const resp = await fetch(url);
        const data = await resp.json();
        renderDescargasTable(data.pedidos, data.total_records);
        renderDescargasPagination(data.page, data.total_pages);
      } catch (e) {
        console.error('Error fetching pedidos:', e);
        document.getElementById('descargasTbody').innerHTML = '<tr><td colspan="5" style="color:red; text-align:center;">Error al cargar los pedidos.</td></tr>';
      }
    }

    function renderDescargasTable(pedidos, totalRecords = 0) {
      const tbody = document.getElementById('descargasTbody');
      const recordCountEl = document.getElementById('descargasRecordCount');
      
      // Actualizar el contador de registros
      if (recordCountEl) {
        recordCountEl.textContent = `Total: ${totalRecords} registro${totalRecords !== 1 ? 's' : ''}`;
      }
      
      if (pedidos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">No se encontraron pedidos.</td></tr>';
        return;
      }
      tbody.innerHTML = pedidos.map(p => {
        let estadoTexto = '';
        switch(Number(p.estado)) {
          case 1:
            estadoTexto = 'Pendiente';
            break;
          case 2:
            estadoTexto = 'Éxito';
            break;
          case 3:
            estadoTexto = 'Sin éxito';
            break;
          default:
            estadoTexto = p.estado;
        }
        const usuario = p.correo || '-';
        return `<tr data-id="${p.id}" class="${selectedIds.has(p.id) ? 'selected' : ''}">
          <td>${estadoTexto}</td>
          <td>${p.identificador}</td>
          <td>${p.tramite}</td>
          <td>${usuario}</td>
          <td>${p.fecha}</td>
          <td>$${parseFloat(p.precio).toFixed(2)}</td>
        </tr>`;
      }).join('');
    }

    function renderDescargasPagination(page, totalPages) {
      descargasCurrentPage = page;
      document.getElementById('descargasPageInfo').textContent = `Página ${page} de ${totalPages}`;
      document.getElementById('descargasPrevPage').disabled = page <= 1;
      document.getElementById('descargasNextPage').disabled = page >= totalPages;
    }
    
    document.getElementById('descargasFilterBtn').addEventListener('click', () => fetchPedidos(1));
    document.getElementById('descargasResetBtn').addEventListener('click', () => {
      document.getElementById('descargasSearchInput').value = '';
      document.getElementById('descargasDateFrom').value = '';
      document.getElementById('descargasDateTo').value = '';
      document.getElementById('descargasStatusFilter').value = '';
      fetchPedidos(1);
    });

    document.getElementById('descargasPrevPage').addEventListener('click', () => {
      if (descargasCurrentPage > 1) {
        fetchPedidos(descargasCurrentPage - 1);
      }
    });

    document.getElementById('descargasNextPage').addEventListener('click', () => {
        fetchPedidos(descargasCurrentPage + 1);
    });

    document.getElementById('descargasExportCsvBtn').addEventListener('click', () => {
      const search = document.getElementById('descargasSearchInput').value.trim();
      const dateFrom = document.getElementById('descargasDateFrom').value;
      const dateTo = document.getElementById('descargasDateTo').value;
      const statusFilter = document.getElementById('descargasStatusFilter').value;
      const params = new URLSearchParams({ search, date_from: dateFrom, date_to: dateTo, status: statusFilter });
      window.location.href = urls.exportCsv + '?' + params;
    });

    document.getElementById('descargasTbody').addEventListener('click', function(e) {
        const row = e.target.closest('tr');
        if (!row || !row.dataset.id) return;

        const rowId = parseInt(row.dataset.id, 10);

        if (e.shiftKey && lastSelectedId !== null) {
            const rows = Array.from(document.querySelectorAll('#descargasTbody tr'));
            const lastIndex = rows.findIndex(r => parseInt(r.dataset.id, 10) === lastSelectedId);
            const currentIndex = rows.findIndex(r => r.dataset.id == rowId);
            const [start, end] = [lastIndex, currentIndex].sort((a, b) => a - b);
            
            rows.slice(start, end + 1).forEach(r => {
                const id = parseInt(r.dataset.id, 10);
                if (!selectedIds.has(id)) {
                    selectedIds.add(id);
                    r.classList.add('selected');
                }
            });
        } else if (e.ctrlKey) {
            if (selectedIds.has(rowId)) {
                selectedIds.delete(rowId);
                row.classList.remove('selected');
            } else {
                selectedIds.add(rowId);
                row.classList.add('selected');
            }
        } else {
            document.querySelectorAll('#descargasTbody tr.selected').forEach(r => r.classList.remove('selected'));
            selectedIds.clear();
            selectedIds.add(rowId);
            row.classList.add('selected');
        }
        
        lastSelectedId = rowId;
    });

    // Confirmación moderna con SweetAlert2
    function showModernConfirm(message, callback) {
      Swal.fire({
        title: '¿Confirmar acción?',
        text: message,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#611232',
        cancelButtonColor: '#aaa',
        confirmButtonText: 'Confirmar',
        cancelButtonText: 'Cancelar',
        customClass: {
          popup: 'swal2-modern',
          confirmButton: 'btn btn-primary',
          cancelButton: 'btn btn-secondary'
        }
      }).then((result) => {
        callback(result.isConfirmed);
      });
    }

    function showToast(message, type = 'primary') {
      const toastEl = document.getElementById('mainToast');
      const toastBody = document.getElementById('mainToastBody');
      toastBody.textContent = message;
      toastEl.className = `toast align-items-center text-bg-${type} border-0`;
      const toast = new bootstrap.Toast(toastEl, { delay: 3500 });
      toast.show();
    }

    // Eliminar seleccionados con confirmación moderna
    document.getElementById('descargasDeleteSelectedBtn').addEventListener('click', async () => {
      const ids = Array.from(selectedIds);
      if (ids.length === 0) {
        showToast('Por favor, selecciona al menos un pedido para eliminar.', 'warning');
        return;
      }
      showModernConfirm(`¿Estás seguro de que quieres eliminar ${ids.length} pedido(s) seleccionados? Esta acción no se puede deshacer.`, async (confirmed) => {
        if (!confirmed) return;
        try {
          // Eliminar pedidos (lógica original)
          const resp = await fetch(urls.deleteFilteredPedidos, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids })
          });
          const data = await resp.json();
          // Eliminar archivos relacionados en la base archivos
          await fetch('/archivos/eliminar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids })
          });
          if (data.success) {
            selectedIds.clear();
            fetchPedidos(descargasCurrentPage);
          } else {
            showToast(data.message, 'danger');
          }
        } catch (e) {
          showToast('Error al eliminar pedidos.', 'danger');
        }
      });
    });

    // Eliminar filtrados con confirmación moderna
    document.getElementById('descargasDeleteFilteredBtn').addEventListener('click', async () => {
      const search = document.getElementById('descargasSearchInput').value.trim();
      const dateFrom = document.getElementById('descargasDateFrom').value;
      const dateTo = document.getElementById('descargasDateTo').value;
      const statusFilter = document.getElementById('descargasStatusFilter').value;

      if (!search && !dateFrom && !dateTo && !statusFilter) {
        Swal.fire({
          icon: 'warning',
          title: 'Filtros requeridos',
          text: 'Debes aplicar al menos un filtro (búsqueda, rango de fechas o estado) para usar la eliminación filtrada.',
          confirmButtonColor: '#611232',
        });
        return;
      }

      showModernConfirm('¿Estás seguro de que quieres eliminar TODOS los pedidos que coinciden con los filtros actuales? Esta acción es irreversible.', async (confirmed) => {
        if (!confirmed) return;
        try {
          // Eliminar pedidos (lógica original)
          const resp = await fetch(urls.deleteFilteredPedidos, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ search, date_from: dateFrom, date_to: dateTo, status: statusFilter })
          });
          const data = await resp.json();
          // Eliminar archivos relacionados en la base archivos (por filtro)
          await fetch('/archivos/eliminar_filtrados', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filtro: { /* puedes agregar más filtros si lo deseas */ } })
          });
          if (data.success) {
            selectedIds.clear();
            fetchPedidos(1); // Reset to page 1 after deletion
          } else {
            showToast(data.message, 'danger');
          }
        } catch (e) {
          showToast('Error al eliminar pedidos.', 'danger');
        }
      });
    });

    // Filtrado en tiempo real al cambiar el select de estado
    document.getElementById('descargasStatusFilter').addEventListener('change', () => fetchPedidos(1));

    // Cargar datos cuando se abre el collapsible
    const descargasCollapse = document.getElementById('descargasCollapse');
    const observer = new MutationObserver((mutations) => {
        for (let mutation of mutations) {
            if (mutation.attributeName === 'style' && descargasCollapse.style.display === 'block') {
                fetchPedidos();
            }
        }
    });
    observer.observe(descargasCollapse, { attributes: true });

    // ========== USUARIOS FUNCTIONS ==========
    let usuariosData = [];
    let usuariosFiltrados = [];
    let usuariosPaginaActual = 1;
    const usuariosPorPagina = 20;

    async function cargarUsuarios(page = 1) {
      try {
        const response = await fetch(`/obtener_usuarios?page=${page}`);
        const data = await response.json();
        
        if (data.success) {
          usuariosData = data.usuarios;
          usuariosPaginaActual = page;
          mostrarUsuarios(data.usuarios, data.total);
        } else {
          document.getElementById('usuariosTableBody').innerHTML = 
            '<tr><td colspan="5" class="vacio">Error al cargar usuarios</td></tr>';
        }
      } catch (error) {
        console.error('Error al cargar usuarios:', error);
        document.getElementById('usuariosTableBody').innerHTML = 
          '<tr><td colspan="5" class="vacio">Error al cargar usuarios</td></tr>';
      }
    }

    function mostrarUsuarios(usuarios, total) {
      const tbody = document.getElementById('usuariosTableBody');
      const totalPaginas = Math.max(1, Math.ceil(total / usuariosPorPagina));
      
      if (usuarios.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="vacio">No hay usuarios</td></tr>';
        document.getElementById('usuariosPaginacion').innerHTML = '';
        return;
      }

      tbody.innerHTML = usuarios.map(u => `
        <tr data-usuario-id="${u.id}">
          <td data-label="Celular">${u.celular}</td>
          <td data-label="Correo">${u.correo}</td>
          <td data-label="Contraseña">
            <input type="password" class="table-input usuario-password" value="••••••••" data-usuario-id="${u.id}" data-id="${u.id}" />
          </td>
          <td data-label="Saldo">${u.saldo}</td>
          <td data-label="Acción">
            <button class="btn btn-danger btn-eliminar-usuario" type="button" data-usuario-id="${u.id}" title="Eliminar">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
            </button>
          </td>
        </tr>
      `).join('');

      // Agregar manejadores para password inputs
      setTimeout(() => {
        document.querySelectorAll('.usuario-password').forEach(input => {
          input.addEventListener('blur', guardarPasswordUsuario);
        });
      }, 0);

      // Renderizar paginación
      const pagDiv = document.getElementById('usuariosPaginacion');
      let pagHtml = '';
      if (totalPaginas > 1) {
        pagHtml += `<button ${usuariosPaginaActual === 1 ? 'disabled' : ''} onclick="cambiarPaginaUsuarios(${usuariosPaginaActual - 1})">Anterior</button>`;
        for (let i = 1; i <= totalPaginas; i++) {
          pagHtml += `<button ${i === usuariosPaginaActual ? 'style=\'background:#611232;color:#fff\'' : ''} onclick="cambiarPaginaUsuarios(${i})">${i}</button>`;
        }
        pagHtml += `<button ${usuariosPaginaActual === totalPaginas ? 'disabled' : ''} onclick="cambiarPaginaUsuarios(${usuariosPaginaActual + 1})">Siguiente</button>`;
      }
      pagDiv.innerHTML = pagHtml;
    }

    async function guardarPasswordUsuario(event) {
      const input = event.target;
      const usuarioId = input.getAttribute('data-usuario-id');
      const nuevaPassword = input.value.trim();

      if (!nuevaPassword || nuevaPassword === '••••••••') {
        Swal.fire({ icon: 'info', title: 'Cancelado', text: 'No se cambió la contraseña.' });
        input.value = '••••••••';
        return;
      }

      if (nuevaPassword.length < 4) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'La contraseña debe tener al menos 4 caracteres.' });
        input.value = '••••••••';
        return;
      }

      try {
        const response = await fetch(`/usuarios/${usuarioId}/actualizar_password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nueva_password: nuevaPassword })
        });

        const data = await response.json();
        if (data.success) {
          Swal.fire({ icon: 'success', title: '¡Listo!', text: 'Contraseña actualizada.' });
          input.value = '••••••••';
        } else {
          Swal.fire({ icon: 'error', title: 'Error', text: data.message });
          input.value = '••••••••';
        }
      } catch (error) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo actualizar la contraseña.' });
        input.value = '••••••••';
      }
    }

    function cambiarPaginaUsuarios(nuevaPagina) {
      cargarUsuarios(nuevaPagina);
    }

    function filtrarUsuarios() {
      const texto = document.getElementById('usuariosSearchInput').value.toLowerCase();
      let filtrados = usuariosData;

      if (texto) {
        filtrados = filtrados.filter(u => 
          u.celular.toLowerCase().includes(texto) ||
          u.correo.toLowerCase().includes(texto)
        );
      }

      usuariosFiltrados = filtrados;
      usuariosPaginaActual = 1;
      mostrarUsuarios(filtrados, filtrados.length);
    }

    function limpiarFiltrosUsuarios() {
      document.getElementById('usuariosSearchInput').value = '';
      usuariosPaginaActual = 1;
      if (usuariosData.length > 0) {
        mostrarUsuarios(usuariosData, usuariosData.length);
      } else {
        cargarUsuarios();
      }
    }

    // Event listener para filtro de búsqueda en usuarios
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('usuariosSearchInput');
      if (searchInput) {
        searchInput.addEventListener('input', filtrarUsuarios);
      }

      // Cargar usuarios cuando se abre la sección
      const usuariosCollapse = document.getElementById('usuariosCollapse');
      const usuariosObserver = new MutationObserver((mutations) => {
        for (let mutation of mutations) {
          if (mutation.attributeName === 'style' && usuariosCollapse.style.display === 'block' && usuariosData.length === 0) {
            cargarUsuarios();
          }
        }
      });
      usuariosObserver.observe(usuariosCollapse, { attributes: true });
    });

    // Eliminar usuario
    document.addEventListener('click', function(e) {
      if (e.target.closest('.btn-eliminar-usuario')) {
        const btn = e.target.closest('.btn-eliminar-usuario');
        const usuarioId = btn.getAttribute('data-usuario-id');
        Swal.fire({
          title: '¿Eliminar usuario?',
          text: 'Esta acción no se puede deshacer.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#611232',
          cancelButtonColor: '#aaa',
          confirmButtonText: 'Eliminar',
          cancelButtonText: 'Cancelar'
        }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              const resp = await fetch(`/usuarios/${usuarioId}/eliminar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });
              const data = await resp.json();
              if (data.success) {
                Swal.fire({ icon: 'success', title: 'Eliminado', text: 'Usuario eliminado correctamente.' });
                cargarUsuarios(usuariosPaginaActual);
              } else {
                Swal.fire({ icon: 'error', title: 'Error', text: data.message });
              }
            } catch (error) {
              Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo eliminar el usuario.' });
            }
          }
        });
      }
    });

    // ========== HISTORIAL DE SALDOS FUNCTIONS ==========
    let saldosCurrentPage = 1;
    let saldosSelectedIds = new Set();

    async function fetchSaldos(page = 1) {
      const search = document.getElementById('saldosSearchInput').value.trim();
      const dateFrom = document.getElementById('saldosDateFrom').value;
      const dateTo = document.getElementById('saldosDateTo').value;

      const params = new URLSearchParams({ page, search, date_from: dateFrom, date_to: dateTo });
      const url = '/api/saldos?' + params;

      try {
        const resp = await fetch(url);
        const data = await resp.json();
        renderSaldosTable(data.saldos);
        renderSaldosPagination(data.page, data.total_pages);
      } catch (e) {
        console.error('Error fetching saldos:', e);
        document.getElementById('saldosTbody').innerHTML = '<tr><td colspan="5" style="color:red; text-align:center;">Error al cargar los saldos.</td></tr>';
      }
    }

    function renderSaldosTable(saldos) {
      const tbody = document.getElementById('saldosTbody');
      if (saldos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">No se encontraron registros de saldos.</td></tr>';
        return;
      }
      tbody.innerHTML = saldos.map(s => {
        const abono = parseFloat(s.abono).toFixed(2);
        return `<tr data-id="${s.id}" class="${saldosSelectedIds.has(s.id) ? 'selected' : ''}">
          <td><input type="checkbox" class="saldos-checkbox" value="${s.id}" ${saldosSelectedIds.has(s.id) ? 'checked' : ''} /></td>
          <td>${s.id}</td>
          <td>${s.usuario}</td>
          <td>$${abono}</td>
          <td>${s.fecha}</td>
        </tr>`;
      }).join('');

      // Agregar event listeners a los checkboxes
      document.querySelectorAll('.saldos-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const row = this.closest('tr');
          const id = parseInt(this.value, 10);
          if (this.checked) {
            saldosSelectedIds.add(id);
            row.classList.add('selected');
          } else {
            saldosSelectedIds.delete(id);
            row.classList.remove('selected');
          }
          updateSaldosSelectAll();
        });
      });
    }

    function renderSaldosPagination(page, totalPages) {
      saldosCurrentPage = page;
      document.getElementById('saldosPageInfo').textContent = `Página ${page} de ${totalPages}`;
      document.getElementById('saldosPrevPage').disabled = page <= 1;
      document.getElementById('saldosNextPage').disabled = page >= totalPages;
    }

    function updateSaldosSelectAll() {
      const checkboxes = document.querySelectorAll('.saldos-checkbox');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      const selectAllCheckbox = document.getElementById('saldosSelectAll');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = allChecked && checkboxes.length > 0;
      }
    }

    document.getElementById('saldosSelectAll').addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.saldos-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
        const row = checkbox.closest('tr');
        const id = parseInt(checkbox.value, 10);
        if (this.checked) {
          saldosSelectedIds.add(id);
          row.classList.add('selected');
        } else {
          saldosSelectedIds.delete(id);
          row.classList.remove('selected');
        }
      });
    });

    document.getElementById('saldosFilterBtn').addEventListener('click', () => fetchSaldos(1));
    
    document.getElementById('saldosResetBtn').addEventListener('click', () => {
      document.getElementById('saldosSearchInput').value = '';
      document.getElementById('saldosDateFrom').value = '';
      document.getElementById('saldosDateTo').value = '';
      saldosSelectedIds.clear();
      fetchSaldos(1);
    });

    document.getElementById('saldosPrevPage').addEventListener('click', () => {
      if (saldosCurrentPage > 1) {
        fetchSaldos(saldosCurrentPage - 1);
      }
    });

    document.getElementById('saldosNextPage').addEventListener('click', () => {
      fetchSaldos(saldosCurrentPage + 1);
    });

    document.getElementById('saldosExportCsvBtn').addEventListener('click', () => {
      const search = document.getElementById('saldosSearchInput').value.trim();
      const dateFrom = document.getElementById('saldosDateFrom').value;
      const dateTo = document.getElementById('saldosDateTo').value;
      const params = new URLSearchParams({ search, date_from: dateFrom, date_to: dateTo });
      window.location.href = '/export/saldos/csv?' + params;
    });

    document.getElementById('saldosDeleteSelectedBtn').addEventListener('click', () => {
      if (saldosSelectedIds.size === 0) {
        Swal.fire({ icon: 'warning', title: 'Selecciona registros', text: 'Por favor selecciona al menos un registro.' });
        return;
      }
      Swal.fire({
        icon: 'warning',
        title: '¿Eliminar registros?',
        text: `Se eliminarán ${saldosSelectedIds.size} registros de saldos.`,
        showCancelButton: true,
        confirmButtonText: 'Eliminar',
        cancelButtonText: 'Cancelar'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const ids = Array.from(saldosSelectedIds);
            const resp = await fetch('/api/saldos/delete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ids })
            });
            const data = await resp.json();
            if (data.success) {
              Swal.fire({ icon: 'success', title: 'Éxito', text: data.message });
              saldosSelectedIds.clear();
              fetchSaldos(1);
            } else {
              Swal.fire({ icon: 'error', title: 'Error', text: data.message });
            }
          } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo eliminar los registros.' });
          }
        }
      });
    });

    document.getElementById('saldosDeleteFilteredBtn').addEventListener('click', () => {
      const search = document.getElementById('saldosSearchInput').value.trim();
      const dateFrom = document.getElementById('saldosDateFrom').value;
      const dateTo = document.getElementById('saldosDateTo').value;

      if (!search && !dateFrom && !dateTo) {
        Swal.fire({ icon: 'warning', title: 'Especifica filtros', text: 'Por favor aplica al menos un filtro para eliminar registros.' });
        return;
      }

      Swal.fire({
        icon: 'warning',
        title: '¿Eliminar registros filtrados?',
        text: 'Se eliminarán todos los registros que coincidan con los filtros aplicados.',
        showCancelButton: true,
        confirmButtonText: 'Eliminar',
        cancelButtonText: 'Cancelar'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const resp = await fetch('/api/saldos/delete-filtered', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ search, date_from: dateFrom, date_to: dateTo })
            });
            const data = await resp.json();
            if (data.success) {
              Swal.fire({ icon: 'success', title: 'Éxito', text: data.message });
              saldosSelectedIds.clear();
              fetchSaldos(1);
            } else {
              Swal.fire({ icon: 'error', title: 'Error', text: data.message });
            }
          } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo eliminar los registros.' });
          }
        }
      });
    });

    // Cargar saldos al abrir la sección
    let saldosLoaded = false;
    const saldosHeaderEl = document.querySelector('.collapsible-header:nth-of-type(5)');
    if (saldosHeaderEl) {
      saldosHeaderEl.addEventListener('click', function() {
        const collapse = this.nextElementSibling;
        const isVisible = collapse.style.display !== 'none';
        if (!isVisible && !saldosLoaded) {
          fetchSaldos(1);
          saldosLoaded = true;
        }
      });
    }

    // ========== TRÁMITES PROCESADOS FUNCTIONS ==========
    let tramitesCurrentPage = 1;
    let tramitesSelectedIds = new Set();

    async function fetchTramites(page = 1) {
      const search = document.getElementById('tramitesSearchInput').value.trim();
      const dateFrom = document.getElementById('tramitesDateFrom').value;
      const dateTo = document.getElementById('tramitesDateTo').value;

      const params = new URLSearchParams({ page, search, date_from: dateFrom, date_to: dateTo });
      const url = urls.apiTramites + '?' + params;

      try {
        const resp = await fetch(url);
        const data = await resp.json();
        if (data.success) {
          renderTramitesTable(data.procesados);
          renderTramitesPagination(data.page, data.total_pages);
        } else {
          document.getElementById('tramitesTbody').innerHTML = '<tr><td colspan="5" style="color:red; text-align:center;">Error al cargar datos.</td></tr>';
        }
      } catch (e) {
        console.error('Error fetching tramites:', e);
        document.getElementById('tramitesTbody').innerHTML = '<tr><td colspan="5" style="color:red; text-align:center;">Error al cargar los trámites.</td></tr>';
      }
    }

    function renderTramitesTable(tramites) {
      const tbody = document.getElementById('tramitesTbody');
      if (tramites.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">No se encontraron trámites.</td></tr>';
        return;
      }
      tbody.innerHTML = tramites.map(t => `
        <tr data-id="${t.id}" class="${tramitesSelectedIds.has(t.id) ? 'selected' : ''}">
          <td style="text-align:center;"><input type="checkbox" class="tramite-checkbox" data-id="${t.id}" ${tramitesSelectedIds.has(t.id) ? 'checked' : ''} style="width:18px; height:18px;"></td>
          <td>${t.identificador}</td>
          <td>${t.tramite}</td>
          <td>${t.solicitud}</td>
          <td>${t.atencion}</td>
        </tr>
      `).join('');

      // Event listeners para checkboxes
      document.querySelectorAll('.tramite-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const id = parseInt(this.getAttribute('data-id'));
          if (this.checked) {
            tramitesSelectedIds.add(id);
            this.closest('tr').classList.add('selected');
          } else {
            tramitesSelectedIds.delete(id);
            this.closest('tr').classList.remove('selected');
          }
          actualizarSelectAll();
        });
      });
    }

    function renderTramitesPagination(page, totalPages) {
      tramitesCurrentPage = page;
      document.getElementById('tramitesPageInfo').textContent = `Página ${page} de ${totalPages}`;
      document.getElementById('tramitesPrevPage').disabled = page <= 1;
      document.getElementById('tramitesNextPage').disabled = page >= totalPages;
    }

    function actualizarSelectAll() {
      const checkboxes = document.querySelectorAll('.tramite-checkbox');
      const selectAll = document.getElementById('tramitesSelectAll');
      const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
      selectAll.checked = allChecked;
    }

    // Evento para select all checkbox
    document.getElementById('tramitesSelectAll').addEventListener('change', function() {
      document.querySelectorAll('.tramite-checkbox').forEach(checkbox => {
        checkbox.checked = this.checked;
        checkbox.dispatchEvent(new Event('change'));
      });
    });

    // Botones de acción
    document.getElementById('tramitesFilterBtn').addEventListener('click', () => fetchTramites(1));
    
    document.getElementById('tramitesResetBtn').addEventListener('click', () => {
      document.getElementById('tramitesSearchInput').value = '';
      document.getElementById('tramitesDateFrom').value = '';
      document.getElementById('tramitesDateTo').value = '';
      tramitesSelectedIds.clear();
      fetchTramites(1);
    });

    document.getElementById('tramitesPrevPage').addEventListener('click', () => {
      if (tramitesCurrentPage > 1) {
        fetchTramites(tramitesCurrentPage - 1);
      }
    });

    document.getElementById('tramitesNextPage').addEventListener('click', () => {
      fetchTramites(tramitesCurrentPage + 1);
    });

    // Respaldar DB
    document.getElementById('tramitesBackupBtn').addEventListener('click', async () => {
      try {
        const resp = await fetch(urls.respaldarTramitesDb, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (resp.ok) {
          // Descargar directamente desde el response
          const blob = await resp.blob();
          const timestamp = new Date().toISOString().replace(/[:.]/g, '').slice(0, 15);
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `tramites_${timestamp}.db`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href);
          Swal.fire({ icon: 'success', title: '¡Listo!', text: 'Base de datos respaldada correctamente' });
        } else {
          const data = await resp.json();
          Swal.fire({ icon: 'error', title: 'Error', text: data.message || 'Error al respaldar' });
        }
      } catch (e) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'Error al respaldar la base de datos.' });
      }
    });

    // Exportar CSV
    document.getElementById('tramitesExportCsvBtn').addEventListener('click', () => {
      const search = document.getElementById('tramitesSearchInput').value.trim();
      const dateFrom = document.getElementById('tramitesDateFrom').value;
      const dateTo = document.getElementById('tramitesDateTo').value;
      const params = new URLSearchParams({ search, date_from: dateFrom, date_to: dateTo });
      window.location.href = urls.exportarTramitesCsv + '?' + params;
    });

    // Eliminar seleccionados
    document.getElementById('tramitesDeleteSelectedBtn').addEventListener('click', async () => {
      const ids = Array.from(tramitesSelectedIds);
      if (ids.length === 0) {
        Swal.fire({ icon: 'warning', title: 'Selecciona registros', text: 'Por favor, selecciona al menos un trámite para eliminar.' });
        return;
      }
      Swal.fire({
        title: '¿Eliminar trámites?',
        text: `¿Estás seguro de que quieres eliminar ${ids.length} trámite(s) seleccionado(s)? Esta acción no se puede deshacer.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#611232',
        cancelButtonColor: '#aaa',
        confirmButtonText: 'Eliminar',
        cancelButtonText: 'Cancelar'
      }).then(async (result) => {
        if (!result.isConfirmed) return;
        try {
          const resp = await fetch(urls.eliminarSeleccionadosTramites, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids })
          });
          const data = await resp.json();
          if (data.success) {
            Swal.fire({ icon: 'success', title: '¡Listo!', text: data.message });
            tramitesSelectedIds.clear();
            fetchTramites(tramitesCurrentPage);
          } else {
            Swal.fire({ icon: 'error', title: 'Error', text: data.message });
          }
        } catch (e) {
          Swal.fire({ icon: 'error', title: 'Error', text: 'Error al eliminar trámites.' });
        }
      });
    });

    // Eliminar filtrados
    document.getElementById('tramitesDeleteFilteredBtn').addEventListener('click', async () => {
      const search = document.getElementById('tramitesSearchInput').value.trim();
      const dateFrom = document.getElementById('tramitesDateFrom').value;
      const dateTo = document.getElementById('tramitesDateTo').value;

      if (!search && !dateFrom && !dateTo) {
        Swal.fire({
          icon: 'warning',
          title: 'Filtros requeridos',
          text: 'Debes aplicar al menos un filtro (búsqueda o rango de fechas) para usar la eliminación filtrada.',
          confirmButtonColor: '#611232',
        });
        return;
      }

      Swal.fire({
        title: '¿Eliminar filtrados?',
        text: '¿Estás seguro de que quieres eliminar TODOS los trámites que coinciden con los filtros actuales? Esta acción es irreversible.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#611232',
        cancelButtonColor: '#aaa',
        confirmButtonText: 'Eliminar',
        cancelButtonText: 'Cancelar'
      }).then(async (result) => {
        if (!result.isConfirmed) return;
        try {
          const resp = await fetch(urls.eliminarFiltradosTramites, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ search, date_from: dateFrom, date_to: dateTo })
          });
          const data = await resp.json();
          if (data.success) {
            Swal.fire({ icon: 'success', title: '¡Listo!', text: data.message });
            tramitesSelectedIds.clear();
            fetchTramites(1);
          } else {
            Swal.fire({ icon: 'error', title: 'Error', text: data.message });
          }
        } catch (e) {
          Swal.fire({ icon: 'error', title: 'Error', text: 'Error al eliminar trámites.' });
        }
      });
    });

    // ===== HORARIOS Y AVISOS =====
    async function loadHorarios() {
      try {
        const resp = await fetch('/api/horarios');
        const data = await resp.json();
        
        if (data.success) {
          const container = document.getElementById('horariosContainer');
          container.innerHTML = '';
          
          data.horarios.forEach(h => {
            const card = document.createElement('div');
            card.className = 'horario-card';
            card.innerHTML = `
              <h4>${h.tramite_nombre}</h4>
              
              <div class="form-group-horario">
                <label>Horario de atención</label>
                <input type="text" class="horario-input" data-id="${h.tramite_id}" value="${h.horario || ''}" placeholder="09:00 a 18:00 Hrs">
              </div>
              
              <div class="form-group-horario">
                <label>Aviso (opcional)</label>
                <textarea class="aviso-input" data-id="${h.tramite_id}" placeholder="Mensaje importante...">${h.aviso || ''}</textarea>
              </div>
              
              <div class="horario-checkboxes">
                <div class="checkbox-group">
                  <input type="checkbox" class="activo-check" data-id="${h.tramite_id}" ${h.activo ? 'checked' : ''}>
                  <label>Activo</label>
                </div>
                <div class="checkbox-group">
                  <input type="checkbox" class="aviso-activo-check" data-id="${h.tramite_id}" ${h.aviso_activo ? 'checked' : ''}>
                  <label>Mostrar aviso</label>
                </div>
              </div>
            `;
            container.appendChild(card);
          });
        }
      } catch (e) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'Error al cargar horarios' });
      }
    }
    
    document.getElementById('guardarHorariosBtn').addEventListener('click', async () => {
      const inputs = document.querySelectorAll('.horario-input');
      let allSuccess = true;
      
      for (let input of inputs) {
        const tramiteId = input.dataset.id;
        const horario = input.value.trim();
        const activo = document.querySelector(`.activo-check[data-id="${tramiteId}"]`).checked;
        const aviso = document.querySelector(`.aviso-input[data-id="${tramiteId}"]`).value.trim();
        const avisoActivo = document.querySelector(`.aviso-activo-check[data-id="${tramiteId}"]`).checked;
        
        if (!horario) {
          Swal.fire({ icon: 'warning', title: 'Advertencia', text: 'El horario no puede estar vacío' });
          allSuccess = false;
          break;
        }
        
        try {
          const resp = await fetch(`/api/horarios/${tramiteId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              horario: horario,
              activo: activo,
              aviso: aviso,
              aviso_activo: avisoActivo
            })
          });
          
          const result = await resp.json();
          if (!result.success) {
            allSuccess = false;
            break;
          }
        } catch (e) {
          allSuccess = false;
          break;
        }
      }
      
      if (allSuccess) {
        Swal.fire({ icon: 'success', title: '¡Listo!', text: 'Horarios y avisos guardados correctamente' });
      } else {
        Swal.fire({ icon: 'error', title: 'Error', text: 'Error al guardar horarios' });
      }
    });
    
    // Cargar horarios cuando se abre el collapsible
    const horariosCollapse = document.getElementById('horariosCollapse');
    const horariosObserver = new MutationObserver((mutations) => {
      for (let mutation of mutations) {
        if (mutation.attributeName === 'style' && horariosCollapse.style.display === 'block') {
          loadHorarios();
        }
      }
    });
    horariosObserver.observe(horariosCollapse, { attributes: true });

    // Cargar datos cuando se abre el collapsible
    const tramitesCollapse = document.getElementById('tramitesCollapse');
    const tramitesObserver = new MutationObserver((mutations) => {
      for (let mutation of mutations) {
        if (mutation.attributeName === 'style' && tramitesCollapse.style.display === 'block') {
          fetchTramites();
        }
      }
    });
    tramitesObserver.observe(tramitesCollapse, { attributes: true });

  </script>
</body>
</html>
